# Back4App Implementation

## Client Side

Code: *precept_back4app_client* package.

Contains implementations for [DataProvider](data-providers.md) and `PDataProvider`.

See the [Tutorial](../tutorial-guide/tutorial.md) for a step by step application starter.

### Invoking Server Initialisation

?????????????

### Server Side Schema Generation

Function: ??????

Server side validation code is actually generated by the client, so that the code can be deployed using the Back4App CLI.


## Server Side

Code: Javascript with Dart tests, *precept_back4app_server* package.

There are two aspects to the server side.

- Every Back4App instance used for Precept needs to have the [framework](#framework) set up.

- A Back4App instance may also be used as a [script store](#script-and-schema-store) to store `PScript` and `PSchema` instances. 

### Framework

The Back4App server-side implementation provides a simple framework, comprising a few Classes and cloud functions.

This supports the use of a single schema for both client and server side, through the use of [server side schema generation](#server-side-schema-generation).

:::tip Note
There is a slight difference in terminology here - for Back4App, every instance is an 'app'.  For Precept, an app may have a dev, test, qa and prod instance (for example),
each of which would be a separate Back4App 'app'.
:::

#### Initialise Instance

Every instance used with a Precept client needs to be initialised, a two step process:

1. the framework code must be deployed to the Back4App instance.  

1. the Cloud function **initPrecept** is invoked to create the Back4App [Classes](#classes) used to manage Schema versions.

Refer to the Tutorial for detailed steps to [create an app](../tutorial-guide/tutorial.md).

## Server Side Framework Classes

### Schema for PreceptState and PreceptStateHistory

| Column             | Type   | Purpose                                                                                                                                                                    |
|--------------------|--------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| artifact           | String | identify 'script' or 'schema'                                                                                                                                              |
| activeVersions     | Array  | A list of int version numbers currently in use.  Must be at least one, but also includes deprecated versions, to simplify lookup                                                                                                     |
| deprecatedVersions | Array  | A list of int version numbers currently in still in use, but will be retired.  Client is notified if a call made to one of these                                    |
| inactiveVersions   | Array  | A list of int version numbers no longer in use.  If a call is made to one of these, the Client is triggered to make an immediate update, and the call not processed |


PreceptStateHistory keeps a record of every change, PreceptState holds just the current state.

This supports the [Development and Release Process](schemas.md#development-and-release-process).

:::tip Note

There is an [outstanding issue](https://gitlab.com/precept1/precept_back4app_client/-/issues/7) to look at restructuring the *precept_back4app_backend* package.
:::


### Script and Schema store

Cloud Function **initScriptStore** prepares Back4App to store version controlled instances of `PScript` and `PSchema`.
 
It needs to be invoked only on the Back4App instance that will be used to store them., which may or may not be the instance being used to hold its data.


                                                                                  |








